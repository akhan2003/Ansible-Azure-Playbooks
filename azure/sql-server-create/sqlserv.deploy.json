{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        
        "vmName": {
            "type": "String"
        },
        "adminUsername": {
            "type": "String"
        },
        "storageAccountName": {
            "type": "String"
        },
        "networkSecurityGroupName": {
            "type": "String"
        },
        "vmSize": {
            "type": "String"
        },
     	"tagvalues": {
      	"type": "object",
      	"defaultValue": {
	      "ApplicationName": "SQL Server",
	      "CostCenter": "5501936",
              "Description": "Sql server windows",
	      "CreatedBy": "NIS NDX CD Team",
              "Environment": "DEV",
              "OS": "Windows",
	      "ServerRole": "SQLDB"
      }
    },
        "adminPassword": {
            "type": "SecureString"
        },
        "virtualNetworkName": {
            "type": "SecureString"
        },
        "subnet1Name": {
            "type": "SecureString"
        }
    },
    "variables": {
		"sqlPortNumber": 1433,
		"sqlStorageDisksCount": 1,
		"sqlStorageWorkloadType": "General",
		"sqlAutopatchingDayOfWeek": "Sunday",
		"sqlAutopatchingStartHour": "2",
		"sqlAutopatchingWindowDuration": "60",
        "vnetId": "[resourceId('BUYNONPROD1-NW','Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]",
		"location": "[resourceGroup().location]",
        "subnetRef": "[concat(variables('vnetId'), '/subnets/', parameters('subnet1Name'))]",
		"osDiskName": "osDisk1",
		"sqlConnectivityType": "Public",
		"networkInterfaceName": "[concat(parameters('vmName'),'-NIC')]"
        
    },
    "resources": [
        {
            "type": "Microsoft.Compute/virtualMachines",
            "name": "[parameters('vmName')]",
            "apiVersion": "2015-06-15",
            "location": "[variables('location')]",
            "tags": {
            "ApplicationName": "[parameters('tagvalues').ApplicationName]",
	          "CostCenter": "[parameters('tagvalues').CostCenter]",
            "Description": "[parameters('tagvalues').Description]",
	          "CreatedBy": "[parameters('tagvalues').CreatedBy]",
            "Environment": "[parameters('tagvalues').Environment]",
            "OS": "[parameters('tagvalues').OS]",
	          "ServerRole": "[parameters('tagvalues').ServerRole]"
      		},
            "properties": {
                "osProfile": {
                    "computerName": "[parameters('vmName')]",
                    "adminUsername": "[parameters('adminUsername')]",
                    "adminPassword": "[parameters('adminPassword')]",
                    "windowsConfiguration": {
                        "provisionVmAgent": "true"
                    }
                },
                "hardwareProfile": {
                    "vmSize": "[parameters('vmSize')]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "MicrosoftSQLServer",
                        "offer": "SQL2014SP1-WS2012R2",
                        "sku": "Standard",
                        "version": "latest"
                    },
                    "osDisk": {
                        "name": "[parameters('vmName')]",
                        "vhd": {
                            "uri": "[concat(concat(reference(resourceId('BUYDEV1NDXNISRG-APP', 'Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2015-06-15').primaryEndpoints['blob'], 'vhds/'), parameters('vmName'), variables('osDiskName'), '.vhd')]"
                        },
                        "createOption": "fromImage"
                    }
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('networkInterfaceName'))]"
                        }
                    ]
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Network/networkInterfaces/', variables('networkInterfaceName'))]",
            ]
        },
        {
            "type": "Microsoft.Compute/virtualMachines/extensions",
            "name": "[concat(parameters('vmName'), '/SqlIaasExtension')]",
            "apiVersion": "2015-06-15",
            "location": "[variables('location')]",
            "properties": {
                "type": "SqlIaaSAgent",
                "publisher": "Microsoft.SqlServer.Management",
                "typeHandlerVersion": "1.2",
                "autoUpgradeMinorVersion": "true",
                "settings": {
                    "AutoTelemetrySettings": {
                        "Region": "[variables('location')]"
                    },
                    "AutoPatchingSettings": {
                        "PatchCategory": "WindowsMandatoryUpdates",
                        "Enable": true,
                        "DayOfWeek": "[variables('sqlAutopatchingDayOfWeek')]",
                        "MaintenanceWindowStartingHour": "[variables('sqlAutopatchingStartHour')]",
                        "MaintenanceWindowDuration": "[variables('sqlAutopatchingWindowDuration')]"
                    },
                    "AutoBackupSettings": {
                        "Enable": false,
                        "RetentionPeriod": "30",
                        "EnableEncryption": false
                    },
                    "KeyVaultCredentialSettings": {
                        "Enable": false,
                        "CredentialName": ""
                    }
                },
                "protectedSettings": {}
            },
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'))]",
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "prepareSqlVmDeployment",
            "apiVersion": "2015-01-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://sqlvmgroup.blob.core.windows.net/singlevm/preparingSqlServerSa.json"
                },
                "parameters": {
                    "sqlVMName": {
                        "value": "[parameters('vmName')]"
                    },
                    "location": {
                        "value": "[variables('location')]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "sqlUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "sqlPassword": {
                        "value": "[parameters('adminPassword')]"
                    },
                    "disksCount": {
                        "value": "[variables('sqlStorageDisksCount')]"
                    },
                    "diskSizeInGB": {
                        "value": 250
                    },
                    "sqlEnginePort": {
                        "value": "[variables('sqlPortNumber')]"
                    },
                    "workloadType": {
                        "value": "[variables('sqlStorageWorkloadType')]"
                    },
                    "connectionType": {
                        "value": "[variables('sqlConnectivityType')]"
                    },
                    "sqlVMPrepareModulesURL": {
                        "value": "https://sqlvmgroup.blob.core.windows.net/singlevm/PrepareSqlServer.ps1.zip"
                    },
                    "sqlVMPrepareConfigurationFunction": {
                        "value": "PrepareSqlServerSa.ps1\\PrepareSqlServerSa"
                    }
                }
            },
            "dependsOn": [
                "[concat('Microsoft.Compute/virtualMachines/', parameters('vmName'), '/extensions/SqlIaasExtension')]"
            ]
        },
        {
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[variables('networkInterfaceName')]",
            "apiVersion": "2015-05-01-preview",
            "location": "[variables('location')]",
            "properties": {
                "primary": true,
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "subnet": {
                                "id": "[variables('subnetRef')]"
                            },
                            "privateIPAllocationMethod": "Dynamic",
                        }
                    }
                ],
                "networkSecurityGroup": {
                    "id": "[resourceId('BUYDEV1NDXNISRG-APP', 'Microsoft.Network/networkSecurityGroups', parameters('networkSecurityGroupName'))]"
                }
            },
            "dependsOn": [
            ]
        }
    ],
    "outputs": {
        "adminUsername": {
            "type": "String",
            "value": "[parameters('adminUsername')]"
        },
        "nic": {
           "type": "object",
           "value": "[reference(variables('networkInterfaceName'))]"
        }
    }
}
